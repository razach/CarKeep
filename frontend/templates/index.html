{% extends "base.html" %}

{% block title %}CarKeep - Vehicle Cost Scenarios{% endblock %}

{% block content %}
<!-- Cache busting: {{ timestamp }} -->
<div class="scenarios-container fade-in">
    <div class="hero-section">
        <h1>üöó Vehicle Cost Scenarios</h1>
        <p class="hero-subtitle">Compare your current car costs with potential alternatives</p>
    </div>
    
    <div class="baseline-info">
        <div class="baseline-header">
            <h2>üìä Your Baseline: {{ baseline.vehicle.name }}</h2>
            <div class="baseline-stats">
                <span class="stat-item">
                    <strong>State:</strong> {{ baseline.state }}
                </span>
                <span class="stat-item">
                    <strong>Current Value:</strong> ${{ "{:,.0f}".format(baseline.vehicle.current_value) }}
                </span>
                <span class="stat-item">
                    <strong>Loan Balance:</strong> ${{ "{:,.0f}".format(baseline.current_loan.principal_balance) }}
                </span>
            </div>
            <div class="baseline-actions">
                <a href="{{ url_for('frontend.edit_baseline') }}" class="btn btn-secondary">
                    ‚úèÔ∏è Edit Baseline
                </a>
            </div>
        </div>
        <p class="baseline-description">{{ baseline.description }}</p>
    </div>
    
    <div class="scenarios-section">
        <div class="section-header">
            <h2>üîÑ Available Scenarios</h2>
            <p>Click on any scenario to view detailed cost comparisons</p>
        </div>
        
        <div class="scenarios-grid">
            {% for scenario_name, scenario_data in scenarios.items() %}
            <div class="scenario-card" data-scenario="{{ scenario_name }}">
                <div class="card-header">
                    <h3>{{ scenario_data.description }}</h3>
                    <div class="scenario-badge">
                        <span class="type {{ scenario_data.scenario.type }}">
                            {{ scenario_data.scenario.type|title }}
                        </span>
                    </div>
                </div>
                
                <div class="scenario-meta">
                    <div class="meta-item">
                        <span class="meta-label">Vehicle:</span>
                        <span class="vehicle">{{ scenario_data.scenario.vehicle.name }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">MSRP:</span>
                        <span class="price">${{ "{:,.0f}".format(scenario_data.scenario.vehicle.msrp) }}</span>
                    </div>
                    {% if scenario_data.scenario.financing.monthly_payment %}
                    <div class="meta-item">
                        <span class="meta-label">Monthly Payment:</span>
                        <span class="payment">${{ "{:,.0f}".format(scenario_data.scenario.financing.monthly_payment) }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="scenario-actions">
                    <a href="{{ url_for('frontend.view_scenario', scenario_name=scenario_name) }}" 
                       class="btn btn-primary" data-tooltip="View detailed cost analysis">
                        üìä View Results
                    </a>
                    <a href="{{ url_for('frontend.edit_scenario', scenario_name=scenario_name) }}" 
                       class="btn btn-secondary" data-tooltip="Edit this scenario">
                        ‚úèÔ∏è Edit
                    </a>
                    <button class="btn btn-info" onclick="duplicateScenario('{{ scenario_name }}')" 
                            data-tooltip="Create a copy of this scenario">
                        üìã Duplicate
                    </button>
                    <button class="btn btn-danger" onclick="deleteScenario('{{ scenario_name }}', '{{ scenario_data.description }}')" 
                            data-tooltip="Delete this scenario">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="actions">
        <a href="{{ url_for('frontend.create_scenario') }}" class="btn btn-success">
            ‚ûï Create New Scenario
        </a>
        <a href="{{ url_for('frontend.comparison') }}" class="btn btn-info">
            <i class="fas fa-chart-bar"></i>
            Compare Scenarios
        </a>
    </div>
    
    <div class="quick-stats">
        <div class="stat-card">
            <div class="stat-number">{{ scenarios|length }}</div>
            <div class="stat-label">Total Scenarios</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ scenarios.values() | selectattr('scenario.type', 'equalto', 'lease') | list | length }}</div>
            <div class="stat-label">Lease Options</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ scenarios.values() | selectattr('scenario.type', 'equalto', 'loan') | list | length }}</div>
            <div class="stat-label">Loan Options</div>
        </div>
    </div>
</div>

<script>
function duplicateScenario(scenarioName) {
    // TODO: Implement scenario duplication
    alert('Scenario duplication coming soon!');
}

function deleteScenario(scenarioName, description) {
    if (confirm(`Are you sure you want to delete "${description}"?\n\nThis action cannot be undone.`)) {
        // Show loading state
        const deleteBtn = event.target;
        const originalText = deleteBtn.innerHTML;
        deleteBtn.innerHTML = 'üóëÔ∏è Deleting...';
        deleteBtn.disabled = true;
        
        console.log('Deleting scenario:', scenarioName); // Debug log
        
        // Make delete request
        fetch(`/scenario/${scenarioName}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            console.log('Response status:', response.status); // Debug log
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data); // Debug log
            if (data.success) {
                // Remove the scenario card from the UI
                const scenarioCard = document.querySelector(`[data-scenario="${scenarioName}"]`);
                if (scenarioCard) {
                    scenarioCard.remove();
                    console.log('Scenario card removed from UI'); // Debug log
                } else {
                    console.log('Scenario card not found in UI'); // Debug log
                }
                
                // Update the total scenarios count
                updateScenarioCounts();
                
                // Show success message
                showNotification('Scenario deleted successfully!', 'success');
                
                // Refresh the page to ensure UI is in sync
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification(data.message || 'Failed to delete scenario', 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting scenario:', error);
            showNotification('An error occurred while deleting the scenario', 'error');
        })
        .finally(() => {
            // Reset button state
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        });
    }
}

function updateScenarioCounts() {
    // Update the total scenarios count
    const scenarioCards = document.querySelectorAll('.scenario-card');
    const totalScenarios = document.querySelector('.stat-card .stat-number');
    if (totalScenarios) {
        totalScenarios.textContent = scenarioCards.length;
    }
    
    // Update lease/loan counts
    const leaseCount = document.querySelectorAll('.scenario-card .type.lease').length;
    const loanCount = document.querySelectorAll('.scenario-card .type.loan').length;
    
    const leaseStat = document.querySelectorAll('.stat-card .stat-number')[1];
    const loanStat = document.querySelectorAll('.stat-card .stat-number')[2];
    
    if (leaseStat) leaseStat.textContent = leaseCount;
    if (loanStat) loanStat.textContent = loanCount;
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()">√ó</button>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}
</script>

<style>
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 1rem;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.notification-success {
    background: #27ae60;
}

.notification-error {
    background: #e74c3c;
}

.notification-info {
    background: #3498db;
}

.notification button {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0;
    margin: 0;
}

.notification button:hover {
    opacity: 0.8;
}

.btn-danger {
    background: #e74c3c;
    color: white;
    border: 1px solid #e74c3c;
}

.btn-danger:hover {
    background: #c0392b;
    border-color: #c0392b;
}

.btn-danger:disabled {
    background: #95a5a6;
    border-color: #95a5a6;
    cursor: not-allowed;
}
</style>
{% endblock %}
