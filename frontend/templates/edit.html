{% extends "base.html" %}

{% block title %}CarKeep - Edit Scenario{% endblock %}

{% block content %}
{% from "components/form_components.html" import basic_info_section, vehicle_details_section, financing_section, trade_in_section, operating_costs_section, form_actions, form_javascript %}

<div class="edit-scenario fade-in">
    <div class="edit-header">
        <h1>✏️ Edit Scenario: {{ scenario_name }}</h1>
        <p>Modify the details of your vehicle cost comparison scenario</p>
        <div class="header-actions">
            <a href="{{ url_for('frontend.view_scenario', scenario_name=scenario_name) }}" class="btn btn-secondary">← Back to Scenario</a>
            <a href="{{ url_for('frontend.index') }}" class="btn btn-outline">← Back to Scenarios</a>
        </div>
    </div>
    
    <div class="edit-form">
        <form method="POST" action="{{ url_for('frontend.edit_scenario', scenario_name=scenario_name) }}" id="editForm">
            {{ basic_info_section(
                scenario_name=scenario_name,
                description=scenario_data.description,
                readonly=true
            ) }}
            
            {{ vehicle_details_section(
                vehicle_name=scenario_data.scenario.vehicle.name,
                msrp=scenario_data.scenario.vehicle.msrp,
                current_value=scenario_data.scenario.vehicle.current_value,
                state=scenario_data.get('state', '')
            ) }}
            
            {{ financing_section(
                financing_type=scenario_data.scenario.type,
                monthly_payment=scenario_data.scenario.financing.monthly_payment,
                lease_terms=scenario_data.scenario.financing.get('lease_terms', 36),
                loan_term=scenario_data.scenario.financing.get('loan_term', 60),
                interest_rate=(scenario_data.scenario.financing.get('interest_rate', 0.055) * 100) | round(1)
            ) }}
            
            {{ trade_in_section(
                trade_in_value=scenario_data.trade_in.trade_in_value,
                incentives=scenario_data.trade_in.incentives
            ) }}
            
            {{ operating_costs_section(
                monthly_insurance=scenario_data.get('cost_config', {}).get('monthly_insurance', 100),
                monthly_maintenance=scenario_data.get('cost_config', {}).get('monthly_maintenance', 50),
                monthly_fuel=scenario_data.get('cost_config', {}).get('monthly_fuel', 150),
                investment_return_rate=(scenario_data.get('cost_config', {}).get('investment_return_rate', 0.06) * 100) | round(1)
            ) }}
            
            {{ form_actions(
                submit_text="Update Scenario",
                show_delete=true,
                scenario_name=scenario_name
            ) }}
        </form>
    </div>
</div>

<script>
// Form submission handler
document.getElementById('editForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitButton = form.querySelector('button[type="submit"]');
    const btnText = submitButton.querySelector('.btn-text');
    const btnLoading = submitButton.querySelector('.btn-loading');
    
    // Show loading state
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    submitButton.disabled = true;
    
    // Get form data
    const formData = new FormData(form);
    
    // Submit form via fetch
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // Redirect to the scenario view after a short delay
            setTimeout(() => {
                window.location.href = `/scenario/${data.scenario_name}`;
            }, 1500);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while updating the scenario', 'error');
    })
    .finally(() => {
        // Reset button state
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
        submitButton.disabled = false;
    });
});

// Delete scenario function
function deleteScenario(scenarioName) {
    if (confirm(`Are you sure you want to delete the scenario "${scenarioName}"? This action cannot be undone.`)) {
        fetch(`/scenario/${scenarioName}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while deleting the scenario', 'error');
        });
    }
}
</script>

{{ form_javascript() }}
{% endblock %}
