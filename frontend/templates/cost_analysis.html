{% extends "base.html" %}

{% block title %}CarKeep - Cost Analysis{% endblock %}

{% block content %}
<div class="cost-analysis fade-in">
    <div class="analysis-header">
        <h1>üí∞ Cost Analysis</h1>
        <p>3-year financial impact analysis to help you decide: Keep current car or upgrade?</p>
        <div class="header-actions">
            <a href="{{ url_for('frontend.index') }}" class="btn btn-secondary">‚Üê Back to Scenarios</a>
        </div>
    </div>
    
    {% if analysis %}
    <div class="analysis-content">
        <!-- Key Decision Metrics -->
        <div class="decision-metrics">
            <h3>üéØ Key Decision Metrics</h3>
            <div class="metrics-grid">
                <div class="metric-card current">
                    <h4>Keep Current Car</h4>
                    <div class="metric-value">${{ "{:,.0f}".format(analysis.baseline.total_monthly) }}/month</div>
                    <small>Current monthly cost</small>
                </div>
                <div class="metric-card best-monthly">
                    <h4>Lowest Monthly Alternative</h4>
                    <div class="metric-value savings">${{ "{:,.0f}".format(analysis.summary.lowest_monthly_cost) }}/month</div>
                    <small>{{ analysis.summary.lowest_scenario_name }}</small>
                </div>
                <div class="metric-card best-net">
                    <h4>Best 3-Year Value</h4>
                    <div class="metric-value {% if analysis.summary.best_net_cost < 0 %}savings{% else %}cost-increase{% endif %}">
                        ${{ "{:,.0f}".format(analysis.summary.best_net_cost) }}
                    </div>
                    <small>{{ analysis.summary.best_scenario_name }}</small>
                </div>
            </div>
        </div>
        
        <!-- 3-Year Cost Breakdown -->
        <div class="cost-breakdown">
            <h3>üìä 3-Year Total Cost Breakdown</h3>
            <div class="breakdown-tables">
                {% for detailed in analysis.detailed_analysis %}
                <div class="scenario-breakdown">
                    <h4>{{ detailed.vehicle_name }}</h4>
                    <p class="scenario-description">{{ detailed.description }}</p>
                    
                    <div class="cost-matrix">
                        <table>
                            <thead>
                                <tr>
                                    <th>Cost Component</th>
                                    <th>3-Year Total</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Lease/Loan Payments</strong></td>
                                    <td>${{ "{:,.0f}".format(detailed.lease_loan_payment) }}</td>
                                    <td>Monthly payments over 3 years</td>
                                </tr>
                                <tr>
                                    <td><strong>Loan Interest</strong></td>
                                    <td>${{ "{:,.0f}".format(detailed.loan_interest) }}</td>
                                    <td>Interest paid on financing</td>
                                </tr>
                                <tr>
                                    <td><strong>Property Tax</strong></td>
                                    <td>${{ "{:,.0f}".format(detailed.property_tax) }}</td>
                                    <td>Additional property tax over 3 years</td>
                                </tr>
                                <tr>
                                    <td><strong>Insurance</strong></td>
                                    <td>${{ "{:,.0f}".format(detailed.insurance) }}</td>
                                    <td>Insurance costs over 3 years</td>
                                </tr>
                                <tr>
                                    <td><strong>Maintenance</strong></td>
                                    <td>${{ "{:,.0f}".format(detailed.maintenance) }}</td>
                                    <td>Maintenance costs over 3 years</td>
                                </tr>
                                <tr>
                                    <td><strong>Fuel/Electricity</strong></td>
                                    <td>${{ "{:,.0f}".format(detailed.fuel_electricity) }}</td>
                                    <td>Fuel or electricity costs over 3 years</td>
                                </tr>
                                <tr class="subtotal-row">
                                    <td><strong>SUBTOTAL</strong></td>
                                    <td><strong>${{ "{:,.0f}".format(detailed.subtotal) }}</strong></td>
                                    <td>Total costs before equity</td>
                                </tr>
                                <tr class="equity-row">
                                    <td><strong>Equity @ 36 months</strong></td>
                                    <td class="{% if detailed.equity_36mo > 0 %}positive{% else %}negative{% endif %}">
                                        ${{ "{:,.0f}".format(detailed.equity_36mo) }}
                                    </td>
                                    <td>Vehicle value after 3 years</td>
                                </tr>
                                <tr class="investment-row">
                                    <td><strong>Investment Opportunity</strong></td>
                                    <td class="{% if detailed.investment_opportunity > 0 %}positive{% else %}negative{% endif %}">
                                        ${{ "{:,.0f}".format(detailed.investment_opportunity) }}
                                    </td>
                                    <td>What you could earn on saved money</td>
                                </tr>
                                <tr class="net-row">
                                    <td><strong>NET OUT-OF-POCKET</strong></td>
                                    <td class="{% if detailed.net_out_of_pocket < 0 %}savings{% else %}cost-increase{% endif %}">
                                        <strong>${{ "{:,.0f}".format(detailed.net_out_of_pocket) }}</strong>
                                    </td>
                                    <td>Your actual cost after 3 years</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Monthly Cost Evolution -->
        <div class="monthly-evolution">
            <h3>üìà Monthly Cost Evolution</h3>
            <div class="evolution-tables">
                {% for detailed in analysis.detailed_analysis %}
                <div class="evolution-table">
                    <h4>{{ detailed.vehicle_name }}</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Cost Type</th>
                                <th>Monthly Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Payment</td>
                                <td>${{ "{:,.0f}".format(detailed.monthly_evolution.payment) }}</td>
                            </tr>
                            <tr>
                                <td>Property Tax</td>
                                <td>${{ "{:,.0f}".format(detailed.monthly_evolution.property_tax) }}</td>
                            </tr>
                            <tr>
                                <td>Insurance</td>
                                <td>${{ "{:,.0f}".format(detailed.monthly_evolution.insurance) }}</td>
                            </tr>
                            <tr>
                                <td>Maintenance</td>
                                <td>${{ "{:,.0f}".format(detailed.monthly_evolution.maintenance) }}</td>
                            </tr>
                            <tr>
                                <td>Fuel/Electricity</td>
                                <td>${{ "{:,.0f}".format(detailed.monthly_evolution.fuel_electricity) }}</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>TOTAL MONTHLY</strong></td>
                                <td><strong>${{ "{:,.0f}".format(detailed.monthly_evolution.total) }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Decision Summary -->
        <div class="decision-summary">
            <h3>ü§î Decision Summary</h3>
            <div class="summary-content">
                {% if analysis.summary.best_net_cost < 0 %}
                    <div class="decision-recommendation keep">
                        <h4>üí° Recommendation: Keep Your Current Car</h4>
                        <p>Your current vehicle is the most cost-effective option over the next 3 years. 
                        You'll save <strong>${{ "{:,.0f}".format(analysis.summary.best_net_cost * -1) }}</strong> 
                        compared to the best alternative.</p>
                    </div>
                {% else %}
                    <div class="decision-recommendation upgrade">
                        <h4>üí° Recommendation: Consider Upgrading</h4>
                        <p>The best alternative would cost you an additional 
                        <strong>${{ "{:,.0f}".format(analysis.summary.best_net_cost) }}</strong> 
                        over 3 years, but provides a lifestyle upgrade.</p>
                    </div>
                {% endif %}
                
                <div class="decision-factors">
                    <h4>Key Factors to Consider:</h4>
                    <ul>
                        <li><strong>Monthly Budget:</strong> Can you afford the higher monthly payments?</li>
                        <li><strong>Lifestyle Value:</strong> How much is the upgrade worth to you personally?</li>
                        <li><strong>Long-term Planning:</strong> Will this vehicle meet your needs for 5+ years?</li>
                        <li><strong>Financial Goals:</strong> How does this fit with your other financial priorities?</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <h3>‚ö° Next Steps</h3>
            <div class="action-buttons">
                <a href="{{ url_for('frontend.create_scenario') }}" class="btn btn-success">‚ûï Add More Scenarios</a>
                <a href="{{ url_for('frontend.edit_baseline') }}" class="btn btn-warning">‚úèÔ∏è Update Baseline</a>
                <a href="{{ url_for('frontend.comparison') }}" class="btn btn-outline">üìä View Comparison</a>
            </div>
        </div>
    </div>
    
    {% else %}
    <div class="no-scenarios">
        <div class="empty-state">
            <h3>üìù No Scenarios Yet</h3>
            <p>Create scenarios to see detailed cost analysis and make an informed decision.</p>
            <a href="{{ url_for('frontend.create_scenario') }}" class="btn btn-success">Create First Scenario</a>
        </div>
    </div>
    {% endif %}
</div>

<style>
.cost-analysis {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.analysis-header {
    text-align: center;
    margin-bottom: 3rem;
    padding: 2rem;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

.analysis-header h1 {
    margin-bottom: 1rem;
    font-size: 2.5rem;
    color: #2c3e50;
}

.analysis-header p {
    font-size: 1.1rem;
    color: #7f8c8d;
    margin-bottom: 1.5rem;
}

.header-actions {
    margin-top: 1.5rem;
}

/* Decision Metrics */
.decision-metrics {
    margin-bottom: 3rem;
}

.decision-metrics h3 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 1.5rem;
    color: #2c3e50;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.metric-card {
    background: white;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    text-align: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}

.metric-card.current {
    border-left: 4px solid #3498db;
}

.metric-card.best-monthly {
    border-left: 4px solid #27ae60;
}

.metric-card.best-net {
    border-left: 4px solid #e74c3c;
}

.metric-card h4 {
    margin-bottom: 1rem;
    color: #7f8c8d;
    font-size: 1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.metric-value.savings {
    color: #27ae60;
}

.metric-value.cost-increase {
    color: #e74c3c;
}

.metric-card small {
    color: #95a5a6;
    font-size: 0.9rem;
}

/* Cost Breakdown */
.cost-breakdown {
    margin-bottom: 3rem;
}

.cost-breakdown h3 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 1.5rem;
    color: #2c3e50;
}

.breakdown-tables {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.scenario-breakdown {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
}

.scenario-breakdown h4 {
    background: #f8f9fa;
    margin: 0;
    padding: 1.5rem;
    color: #2c3e50;
    border-bottom: 1px solid #e9ecef;
}

.scenario-description {
    background: #f8f9fa;
    margin: 0;
    padding: 0 1.5rem 1.5rem;
    color: #7f8c8d;
    border-bottom: 1px solid #e9ecef;
}

.cost-matrix table {
    width: 100%;
    border-collapse: collapse;
}

.cost-matrix th {
    background: #f8f9fa;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #2c3e50;
    border-bottom: 1px solid #e9ecef;
}

.cost-matrix td {
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
    vertical-align: top;
}

.cost-matrix tr:last-child td {
    border-bottom: none;
}

.subtotal-row {
    background: #f8f9fa;
    font-weight: 600;
}

.equity-row, .investment-row {
    background: #f8f9fa;
}

.net-row {
    background: #e8f5e8;
    font-weight: 700;
}

.positive {
    color: #27ae60;
}

.negative {
    color: #e74c3c;
}

.savings {
    color: #27ae60;
    font-weight: 600;
}

.cost-increase {
    color: #e74c3c;
    font-weight: 600;
}

/* Monthly Evolution */
.monthly-evolution {
    margin-bottom: 3rem;
}

.monthly-evolution h3 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 1.5rem;
    color: #2c3e50;
}

.evolution-tables {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.evolution-table {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
}

.evolution-table h4 {
    background: #f8f9fa;
    margin: 0;
    padding: 1rem;
    color: #2c3e50;
    border-bottom: 1px solid #e9ecef;
}

.evolution-table table {
    width: 100%;
    border-collapse: collapse;
}

.evolution-table th {
    background: #f8f9fa;
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    color: #2c3e50;
    border-bottom: 1px solid #e9ecef;
}

.evolution-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #e9ecef;
}

.evolution-table .total-row {
    background: #f8f9fa;
    font-weight: 600;
}

/* Decision Summary */
.decision-summary {
    margin-bottom: 3rem;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    padding: 2rem;
}

.decision-summary h3 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 1.5rem;
    color: #2c3e50;
}

.decision-recommendation {
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.decision-recommendation.keep {
    background: #e8f5e8;
    border-left: 4px solid #27ae60;
}

.decision-recommendation.upgrade {
    background: #fff5f5;
    border-left: 4px solid #e74c3c;
}

.decision-recommendation h4 {
    margin-bottom: 1rem;
    color: #2c3e50;
}

.decision-factors h4 {
    margin-bottom: 1rem;
    color: #2c3e50;
}

.decision-factors ul {
    color: #7f8c8d;
    line-height: 1.6;
}

.decision-factors li {
    margin-bottom: 0.5rem;
}

/* Quick Actions */
.quick-actions {
    text-align: center;
    margin-top: 3rem;
}

.quick-actions h3 {
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
    color: #2c3e50;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

/* Empty State */
.no-scenarios {
    text-align: center;
    padding: 4rem 2rem;
}

.empty-state h3 {
    margin-bottom: 1rem;
    color: #2c3e50;
}

.empty-state p {
    color: #7f8c8d;
    margin-bottom: 2rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .cost-analysis {
        padding: 1rem;
    }
    
    .metrics-grid {
        grid-template-columns: 1fr;
    }
    
    .evolution-tables {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .action-buttons .btn {
        width: 100%;
        max-width: 300px;
    }
    
    .cost-matrix {
        overflow-x: auto;
    }
}
</style>
{% endblock %}
