{% extends "base.html" %}

{% block title %}CarKeep - Edit Baseline{% endblock %}

{% block content %}
{% from "form_components.html" import basic_info_section, vehicle_details_section, financing_section, trade_in_section, operating_costs_section, form_actions, form_javascript %}

<div class="edit-baseline fade-in">
    <div class="edit-header">
        <h1>✏️ Edit Baseline Scenario</h1>
        <p>Modify your baseline vehicle and loan information</p>
        <div class="header-actions">
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">← Back to Scenarios</a>
        </div>
    </div>
    
    <div class="edit-form">
        <form method="POST" action="{{ url_for('main.edit_baseline') }}" id="baselineForm">
            {{ basic_info_section(
                description=baseline_data.get('description', ''),
                readonly=false
            ) }}
            
            {{ vehicle_details_section(
                vehicle_name=baseline_data.get('vehicle_name', ''),
                msrp=baseline_data.get('msrp', 0),
                current_value=baseline_data.get('current_value', 0),
                state=baseline_data.get('state', 'VA'),
                show_state_help=true
            ) }}
            
            {{ financing_section(
                financing_type='loan',
                monthly_payment=baseline_data.get('monthly_payment', 0),
                interest_rate=(baseline_data.get('interest_rate', 0.055) * 100) | round(1)
            ) }}
            
            {{ trade_in_section(
                trade_in_value=baseline_data.get('trade_in_value', 0),
                incentives=baseline_data.get('incentives', 0)
            ) }}
            
            {{ operating_costs_section(
                monthly_insurance=baseline_data.get('cost_config', {}).get('monthly_insurance', 100),
                monthly_maintenance=baseline_data.get('cost_config', {}).get('monthly_maintenance', 50),
                monthly_fuel=baseline_data.get('cost_config', {}).get('monthly_fuel', 150),
                investment_return_rate=(baseline_data.get('cost_config', {}).get('investment_return_rate', 0.06) * 100) | round(1)
            ) }}
            
            {{ form_actions(submit_text="Update Baseline") }}
        </form>
    </div>
</div>

<script>
// Form submission handler
document.getElementById('baselineForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitButton = form.querySelector('button[type="submit"]');
    const btnText = submitButton.querySelector('.btn-text');
    const btnLoading = submitButton.querySelector('.btn-loading');
    
    // Show loading state
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    submitButton.disabled = true;
    
    // Get form data
    const formData = new FormData(form);
    
    // Submit form via fetch
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // Redirect to the homepage after a short delay
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while updating the baseline', 'error');
    })
    .finally(() => {
        // Reset button state
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
        submitButton.disabled = false;
    });
});
</script>

{{ form_javascript() }}
{% endblock %}
